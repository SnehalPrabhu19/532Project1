## CS532_F21_Project1 README
- - - -

### Team Members:
1. Rishabh Garodia
2. Snehal Prabhu
3. Shruti Shelke 

- - - -
### Overview:
This repo contains the code to implement the functionality of Map Reduce from scratch using Java.
- This package initializes a master that loads the input data, decides the chunks for each mapper and initializes the mappers using multiprocessing. 
- Each mapper process then invokes the user defined map method using Java Reflection and generates intermediate outputs using string hashing. 
- The master then waits for all the mapper processes to complete and handles their fault tolerance. 
- Once all mappers are complete, the master initializes reducer processes. 
- Each reducer process then invokes the user defined reduce method using Java Reflection and generates final outputs.

### Assumptions / Constraints:
- Number of mappers = Number of reducers
- Fault Tolerance will only be done for 1 mapper process and 1 reducer process
- Only text file inputs are supported
- Support for any arbitrary number of mappers/reducers has been provided
- Entire data is read only 1 time in the master process and then each child process reads only relevant chunks

### How to Run the automated test cases:
Navigate to the $Root directory of the repo and run the following commands:
1. Compile and execute ```./src/unitTest/automatedTest.java```

### How to use Map Reduce package
Follow the below-mentioned steps:
- Navigate to ```src/test/```
- Create a new folder for new use case and navigate inside it
- Create a new class having your map method
- Create a new class having your reducer method
- Create a ```config.properties``` with the following inputs:
  - Mandatory inputs
    - ```numberOfMappers``` - number of mappers/reducers to be initialized
    - ```inputFilePath``` - Absolute path of the input txt file
    - ```outputFilePath``` - Absolute path of the output txt file
    - ```udfClassMapper``` - Class reference path of the mapper class
    - ```udfClassReducer``` - Class reference path of the reducer class
  - Optional inputs
    - ```removePunctuations``` - 0 if dont remove punctuations, 1 if remove punctuations
    - ```faultFlag``` - 0 if not fault has to be created deliberately, else 1
- Create a new class having the main function that calls the ```SubmitJob``` method from ```mapreduce.mapreduce```
- Execute the main method of your class created in the previous step

### Description of test cases:
We have created 4 automated tests. Below are the details of each test.
1. UDF 1 - Word Count
2. UDF 2 - Count of unique IP addresses
3. UDF 3 - All the occurrences of a specific word - "error" in text
4. Test for fault tolerance using UDF 1

For each of test case, we are running the Map Reduce library to generate an output.
Then we are comparing this output with an output generated by Java implementation of the same logic.
If both the outputs match, then the test case is passed.

### Description of UDF functions:- 
```src/tests/udfn``` Where n is {1,2,3} for our three test cases

- UDF 1 gives the count of each word as output given a text file
  - We use this to analyse text documents like famous play of hamlet by Shakespeare
- UDF 2 finds all the unique occurrences of IP addresses in log and gets their count
  - This can be used to examine all the different IPs accessing the API/server
- UDF 3 looks if the word specified by the user is present in the file
  - We use this to analyse a log of Macbook to find the total number of errors occured
  - It could also be used to count the total number of GET and POST requests on API logs


- Each folder has an input and output folder
- The input folder contains the file we are passing for the test case
- The output folder has the final map-reduce output file of the last run
- There is a config.properties file which contains the file path and the number of mappers information provided by the user
- This folder also has three user defined java classes
- ```udfnMapper.java``` has the user defined mapper function
- ```udfnReducer.java``` has the user defined reducer function
- The ```udftestcasen.java``` creates a new instance of the mapreduce and initializes the job with the config.properties file path


### Description of Classes in Map Reduce Package:
***Master MapReduce Class*** - ```src/mapreduce/mapreduce.java``` :

This is our main class in our map reduce library, essentially working as the master of our entire program
- ```SubmitJob```
  - Assigns all the necessary variables for the program to run such as 
    - file paths, 
    - number of mappers, 
    - user defined map 
    - and reduce functions
  - Starts a new messenger for creating a communication channel between mappers, reducers and the master
  - It keeps track of all the mappers and reducers using the ```ManageMappers``` and ```ManageReducers``` methods respectively
- ```ManageMappers```
  - Manages all the mappers by:
    - Connecting to the communication channel, 
    - creating partitions according to the number of mappers, 
    - creating a process for every mapper and assigning the relevant partition to each mapper
  - It waits for the multiprocessing to be completed and takes care of fault tolerance in the mappers
  - Once all the mapper processes have been completed, the main ```SubmitJob``` function calls on the manage reducer method. 
- ```ManageReducers```
  - Manages all the reducers by:
    - Collecting the paths of the intermediate files written by the mappers,
    - Assigning the relevant reducers their partitions and
    - Starting a process for each reducer
  - It also waits for all the processes to finish completing and takes care of fault tolerance
  - Lastly it deletes all the intermediate files and kills all sockets and servers once all the reducer processes have been completed
  - Once the entire map and reduce program is done, the ```SubmitJob``` prints out that map reduce has been completed and gives us the path for the output files.


**Mapper Class** - ```src/mapreduce/Mapper.java``` :

This is the mapper class for our map reduce implementation and provides the blueprint for each mapper process.

Each mapper will:
- Have a ```mapperID``` assigned to it by the master for identification
- First make a connection to the communication channel via the ```messenger``` class using the defined socket and port
- Receive the following information that is common for all mapper instances through this communication channel
  - input file path, 
  - number of mappers,
  - and the user defined mapper class
- Creates a directory to store intermediate files
- Take in offsets which describe the partition of the input file for this mapper and reads the chunk
- Applies the UDF map function for each line of input
- Applies a hash function to each output key and writes the output to relevant intermediate files

**Reducer Class** - ```src/mapreduce/Reducer.java``` :

This is the reducer class for our map reduce implementation and provides the blueprint for each reducer process.

Each reducer will:
- Have a ```reducerID``` assigned to it by the master for identification
- First make a connection to the communication channel via the ```messenger``` class using the defined socket and port. 
- Receive the following information that is common for all mapper instances through this communication channel:
  - output file path,
  - number of mappers,
  - and the user defined reducer class
- Create the output directory
- It first reads the data from intermediate files that correspond to its reducerID. Because of hashing, all the occurrences of a particular key are always in intermediate files corresponding to a single reducerID
- Sort and shuffle the data according to the relevant keys
- Applies the user defined reduce function on the data it reads and begins writing this output to the output file

**Messenger for Communication Class** - ```src/mapreduce/messenger.java``` :
This messenger class provides the main communication between mappers, reducers and our master mapreduce class. It has the following methods:
- ```connectMapper```
  - Provides the main communication channel for mappers where the socket is set to ‘8888’
  - Shared information for all mappers such as the input file path, user defined mapper class and number of mappers is sent to them by this method after connection has been established
  - It also maintains a list of all the intermediate files created by the mappers
- ```connectReducer```
  - Serves as the main communication channel for reducers where the socket is set to ‘6666’
  - Shared information for all reducers such as the output file path, user defined reducer class is sent to them by this method after connection has been established
  - It also maintains a list of all the output files created by the reducers
- Furthermore, we define methods to get file paths for both intermediate and output files
- And a method to create data streams including setting up the host and port for the sockets

**Utility Function Class** - ```src/mapreduce/utils.java``` :

This is the utility function class of our map reduce library. We defined this class to have all the static routines that can be used by all the instances of MapReduce. 
It has the following methods to:
- Find the file extension for any input data file
- Create and delete directories 
- Write output data which is all used by the reducer class
- Write temp data which is used by the mapper class to write intermediate files based on hashing
- Read temp data from intermediate files by the reducers
- Read the partitions for each mapper using the offsets
- Initialize a process for each mapper and reducer
- Return class names and methods for the user defined functions
- Reading input data and dividing it into partitions as need be for all mappers and reducers


**Fault Tolerance for process crashes** - ```src/mapreduce/faultTolerance.java``` :
- Fault tolerance is only supported for the fault of 1 mapper process and 1 reducer process
- Failure of multiple mapper/reducer processes is not supported
- Failure of restarted mapper/reducer processes is not supported
- faultTolerance class has the following methods
- ```mapperFaultTolerance```
  - Restarts a mapper if it has not received exit status 0 i.e., it did not properly complete its function 
  - Then waits for all the restarted mappers to be completed
- ```reducerFaultTolerance```
  - Restarts a reducer if it has not received exit status 0 i.e., it did not properly complete its function
  - Then waits for all the restarted reducers to be completed

**Pair Class** - ```src/mapreduce/Pair.java``` :
- This is the pair class that is used by the mapper and reducer classes in our map reduce implementation.
- It has a key variable and value variable.
- In this class, we have methods to:
  - get the key,
  - set the key,
  - get the Value,
  - set the Value
  - and convert the key and the value to a string







